<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Writer Dashboard - WorkX</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/styles.css') }}">
</head>
<body>
    <nav class="navbar">
        <div class="container">
            <div class="nav-brand">
                <h1>WorkX</h1>
                <p class="tagline">Writer Dashboard</p>
            </div>
            <ul class="nav-menu">
                <li><a href="/writer-dashboard" class="active">Dashboard</a></li>
                <li><a href="/pricing">Pricing</a></li>
                <li><a href="/logout">Logout</a></li>
            </ul>
        </div>
    </nav>

    <section class="dashboard-section">
        <div class="container">
            <div class="dashboard-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem;">
                <div>
                    <h2>Welcome, <span id="username"></span>! ‚úçÔ∏è</h2>
                </div>
                <div style="display: flex; gap: 1rem; align-items: center; flex-wrap: wrap;">
                    <div class="admin-contact-box" style="background: #f0f4ff; padding: 1rem; border-radius: 8px; border-left: 4px solid #4f46e5;">
                        <strong style="color: #4f46e5;">üìû Admin Contact:</strong>
                        <p style="margin: 0.5rem 0 0 0; font-size: 1.1rem; font-weight: 600;">1234567890</p>
                        <small style="color: #666;">Contact for any queries</small>
                    </div>
                    <button id="refreshBtn" class="btn btn-secondary">üîÑ Refresh</button>
                </div>
            </div>

            <div class="dashboard-stats">
                <div class="stat-card">
                    <h4>Available Tasks</h4>
                    <p class="stat-value" id="availableTasks">0</p>
                </div>
                <div class="stat-card">
                    <h4>My Tasks</h4>
                    <p class="stat-value" id="myTasks">0</p>
                </div>
                <div class="stat-card">
                    <h4>In Progress</h4>
                    <p class="stat-value" id="inProgressTasks">0</p>
                </div>
                <div class="stat-card">
                    <h4>Completed</h4>
                    <p class="stat-value" id="completedTasks">0</p>
                </div>
            </div>

            <div class="tabs-container">
                <div class="tabs">
                    <button class="tab-btn active" data-tab="available">Available Tasks</button>
                    <button class="tab-btn" data-tab="mytasks">My Tasks</button>
                </div>

                <div class="tab-content">
                    <div id="available-tab" class="tab-pane active">
                        <h3>Available Tasks to Claim</h3>
                        <div id="availableLoading" class="loading">Loading available tasks...</div>
                        <div id="availableContent"></div>
                    </div>

                    <div id="mytasks-tab" class="tab-pane">
                        <h3>My Claimed Tasks</h3>
                        <div id="myTasksLoading" class="loading">Loading your tasks...</div>
                        <div id="myTasksContent"></div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <footer class="footer">
        <div class="container">
            <p>&copy; 2025 WorkX - Campus Work Exchange Platform</p>
        </div>
    </footer>

    <script>
        document.getElementById('username').textContent = '{{ session.username }}';

        // Tab switching
        document.querySelectorAll('.tab-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-pane').forEach(p => p.classList.remove('active'));
                
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-tab').classList.add('active');
            });
        });

        async function loadAvailableTasks() {
            document.getElementById('availableLoading').style.display = 'block';
            document.getElementById('availableContent').innerHTML = '';

            try {
                const response = await fetch('/api/writer/available_tasks');
                const data = await response.json();

                if (response.ok) {
                    document.getElementById('availableTasks').textContent = data.tasks.length;
                    renderAvailableTasks(data.tasks);
                } else {
                    alert('Error loading tasks: ' + data.error);
                }
            } catch (error) {
                alert('Failed to load tasks: ' + error.message);
            } finally {
                document.getElementById('availableLoading').style.display = 'none';
            }
        }

        async function loadMyTasks() {
            document.getElementById('myTasksLoading').style.display = 'block';
            document.getElementById('myTasksContent').innerHTML = '';

            try {
                const response = await fetch('/api/writer/my_tasks');
                const data = await response.json();

                if (response.ok) {
                    const myTasksCount = data.tasks.length;
                    const inProgress = data.tasks.filter(t => t.status === 'Assigned' || t.status === 'In Progress').length;
                    const completed = data.tasks.filter(t => t.status === 'Completed').length;
                    
                    document.getElementById('myTasks').textContent = myTasksCount;
                    document.getElementById('inProgressTasks').textContent = inProgress;
                    document.getElementById('completedTasks').textContent = completed;
                    
                    renderMyTasks(data.tasks);
                } else {
                    alert('Error loading tasks: ' + data.error);
                }
            } catch (error) {
                alert('Failed to load tasks: ' + error.message);
            } finally {
                document.getElementById('myTasksLoading').style.display = 'none';
            }
        }

        function renderAvailableTasks(tasks) {
            const container = document.getElementById('availableContent');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="no-tasks"><p>No tasks available at the moment. Check back later!</p></div>';
                return;
            }

            let html = '<div class="tasks-grid">';
            tasks.forEach(task => {
                // Show material cost + TBD for payout
                let priceDisplay = '';
                const materialCost = task.material_cost || 0;
                
                if (materialCost > 0) {
                    priceDisplay = `‚Çπ${materialCost} + TBD`;
                } else {
                    priceDisplay = 'TBD';
                }
                
                html += `
                    <div class="task-card">
                        <div class="task-header">
                            <h4>${task.task_id}</h4>
                            <span class="status-badge status-pending">Available</span>
                        </div>
                        <div class="task-body">
                            <p><strong>Work Type:</strong> ${task.work_type}</p>
                            <p><strong>Payout:</strong> ${priceDisplay}</p>
                            <p><strong>Deadline:</strong> ${task.deadline}</p>
                            <p><strong>Posted:</strong> ${new Date(task.created_at).toLocaleDateString()}</p>
                            ${task.notes ? '<p><strong>Notes:</strong> ' + task.notes + '</p>' : ''}
                            ${task.user_uploaded_files && task.user_uploaded_files.length > 0 ? `
                                <div style="margin-top: 0.5rem;">
                                    <strong>üìé Reference Files (${task.user_uploaded_files.length}):</strong>
                                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                        ${task.user_uploaded_files.map((file, index) => {
                                            const filename = typeof file === 'object' ? file.filename : file;
                                            return `<li><a href="/api/download_user_file/${task.task_id}/${index}" target="_blank" style="color: #4f46e5; text-decoration: underline;">${filename}</a></li>`;
                                        }).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            <p class="text-muted"><small>üìä <a href="/pricing" target="_blank">View Price List</a> - Final price determined after completion</small></p>
                        </div>
                        <div class="task-footer">
                            <button onclick="claimTask('${task.task_id}')" class="btn btn-sm btn-primary">
                                Claim Task
                            </button>
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        function renderMyTasks(tasks) {
            const container = document.getElementById('myTasksContent');
            
            if (tasks.length === 0) {
                container.innerHTML = '<div class="no-tasks"><p>You haven\'t claimed any tasks yet. Browse available tasks to get started!</p></div>';
                return;
            }

            let html = '<div class="tasks-grid">';
            tasks.forEach(task => {
                const statusClass = task.status.toLowerCase().replace(' ', '-');
                const priceDisplay = task.worker_payout ? `‚Çπ${task.worker_payout}` : 'TBD';
                const statusBadgeClass = `status-${statusClass}`;
                
                html += `
                    <div class="task-card status-${statusClass}">
                        <div class="task-header">
                            <h4>${task.task_id}</h4>
                            <span class="status-badge ${statusBadgeClass}">${task.status}</span>
                        </div>
                        <div class="task-body">
                            <p><strong>Work Type:</strong> ${task.work_type}</p>
                            <p><strong>Your Payout:</strong> ${priceDisplay}</p>
                            <p><strong>Deadline:</strong> ${task.deadline}</p>
                            <p><strong>Claimed:</strong> ${task.claimed_at ? new Date(task.claimed_at).toLocaleDateString() : 'N/A'}</p>
                            ${task.notes ? '<p><strong>Notes:</strong> ' + task.notes + '</p>' : ''}
                            ${task.user_uploaded_files && task.user_uploaded_files.length > 0 ? `
                                <div style="margin-top: 0.5rem;">
                                    <strong>üìé Reference Files (${task.user_uploaded_files.length}):</strong>
                                    <ul style="margin: 0.5rem 0; padding-left: 1.5rem;">
                                        ${task.user_uploaded_files.map((file, index) => {
                                            const filename = typeof file === 'object' ? file.filename : file;
                                            return `<li><a href="/api/download_user_file/${task.task_id}/${index}" target="_blank" style="color: #4f46e5; text-decoration: underline;">${filename}</a></li>`;
                                        }).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${task.admin_uploaded_result ? '<p class="task-completed">‚úÖ Submitted to admin</p>' : '<p class="text-warning">‚è≥ Submit to admin when complete</p>'}
                        </div>
                        <div class="task-footer">
                            ${!task.admin_uploaded_result && (task.status === 'In Progress' || task.status === 'Assigned') ? 
                                '<button onclick="markComplete(\'' + task.task_id + '\')" class="btn btn-sm btn-success">‚úÖ Mark Complete</button>' : 
                                task.admin_uploaded_result ? '<span class="badge badge-success">Submitted</span>' : ''}
                        </div>
                        <div class="task-footer">
                            ${task.writer_paid ? '<span class="badge-success">üí∞ Paid</span>' : '<span class="badge-warning">üí∞ Payment Pending</span>'}
                        </div>
                    </div>
                `;
            });
            html += '</div>';
            
            container.innerHTML = html;
        }

        async function claimTask(taskId) {
            if (!confirm('Are you sure you want to claim this task?')) {
                return;
            }

            try {
                const response = await fetch('/api/writer/claim_task', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ task_id: taskId })
                });

                const result = await response.json();

                if (response.ok) {
                    alert(result.message);
                    loadAvailableTasks();
                    loadMyTasks();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (error) {
                alert('Failed to claim task: ' + error.message);
            }
        }

        document.getElementById('refreshBtn').addEventListener('click', () => {
            loadAvailableTasks();
            loadMyTasks();
        });

        // Store current task ID for completion
        let currentTaskId = null;

        // Mark Complete function
        function markComplete(taskId) {
            currentTaskId = taskId;
            // Show modal with admin contact
            document.getElementById('adminContactModal').style.display = 'block';
        }

        // Confirm and mark task as complete
        async function confirmTaskComplete() {
            if (currentTaskId) {
                try {
                    const response = await fetch('/api/writer/mark_complete', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({ task_id: currentTaskId })
                    });

                    const result = await response.json();

                    if (response.ok) {
                        alert('Task marked as complete! Please contact admin to submit your work.');
                        closeAdminModal();
                        // Refresh the tasks to show updated status
                        loadMyTasks();
                        currentTaskId = null;
                    } else {
                        alert('Error: ' + result.error);
                    }
                } catch (error) {
                    alert('Failed to mark task complete: ' + error.message);
                }
            }
        }

        // Close modal function
        function closeAdminModal() {
            document.getElementById('adminContactModal').style.display = 'none';
            currentTaskId = null;
        }

        // Close modal when clicking outside
        window.onclick = function(event) {
            const modal = document.getElementById('adminContactModal');
            if (event.target == modal) {
                modal.style.display = 'none';
            }
        }

        // Initial load
        loadAvailableTasks();
        loadMyTasks();
    </script>

    <!-- Admin Contact Modal -->
    <div id="adminContactModal" class="modal" style="display: none; position: fixed; z-index: 1000; left: 0; top: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.4); overflow: hidden;">
        <div class="modal-content" style="background-color: #fefefe; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); padding: 2rem; border: 1px solid #888; border-radius: 12px; width: 90%; max-width: 450px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); max-height: 90vh; overflow-y: auto;">
            <span class="close" onclick="closeAdminModal()" style="color: #aaa; float: right; font-size: 28px; font-weight: bold; cursor: pointer; line-height: 20px;">&times;</span>
            <div style="text-align: center; padding: 1rem 0;">
                <div style="font-size: 3rem; margin-bottom: 1rem;">‚úÖ</div>
                <h3 style="color: #4f46e5; margin-bottom: 1.5rem;">Submit Work - Admin Contact</h3>
                <div style="background: #f0f4ff; padding: 1.5rem; border-radius: 8px; margin-bottom: 1.5rem; text-align: left;">
                    <div style="margin-bottom: 1rem;">
                        <p style="margin: 0 0 0.3rem 0; font-size: 0.9rem; color: #666;">Name</p>
                        <p style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #1f2937;">Rishi</p>
                    </div>
                    <div style="margin-bottom: 1rem;">
                        <p style="margin: 0 0 0.3rem 0; font-size: 0.9rem; color: #666;">Phone Number</p>
                        <p style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #1f2937;">1234567890</p>
                    </div>
                    <div>
                        <p style="margin: 0 0 0.3rem 0; font-size: 0.9rem; color: #666;">Class</p>
                        <p style="margin: 0; font-size: 1.2rem; font-weight: 600; color: #1f2937;">301</p>
                    </div>
                </div>
                <button onclick="confirmTaskComplete()" class="btn btn-success" style="width: 100%; padding: 0.75rem; font-size: 1rem; font-weight: 600; border: none; border-radius: 6px; cursor: pointer;">
                    ‚úÖ Mark as Completed
                </button>
                <p style="margin-top: 1rem; font-size: 0.85rem; color: #666;">Contact admin to submit your completed work</p>
            </div>
        </div>
    </div>
</body>
</html>
